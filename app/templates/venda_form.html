{% extends 'base.html' %}

{% block conteudo %}
<h1 class="titulo-pagina">Nova Venda</h1>
<form method="post" action="/vendas/nova">
    <div class="campo">
        <label for="cliente_id">Cliente:</label>
        <select name="cliente_id" required>
            {% for cliente in clientes %}
            <option value="{{ cliente.id }}">{{ cliente.nome }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="campo">
        <label for="forma_pagamento">Forma de Pagamento:</label>
        <select name="forma_pagamento" required>
            <option value="avista">Ã€ Vista</option>
            <option value="prazo">A Prazo</option>
        </select>
    </div>

    <div id="itens-venda">
        <div class="item-venda">
            <label>Produto:</label>
            <select name="produto_id">
                {% for produto in produtos %}
                <option value="{{ produto.id }}" data-preco="{{ produto.preco_venda }}">
                    {{ produto.nome }} (R$ {{ '%.2f'|format(produto.preco_venda or 0) }})
                </option>
                {% endfor %}
            </select>
            <label>Quantidade:</label>
            <input type="number" name="quantidade" value="1" min="1">
        </div>
    </div>

    <button type="button" onclick="adicionarItem()">Adicionar Produto</button>

    <div class="campo">
        <label for="desconto">Desconto (R$)</label>
        <input type="number" step="0.01" name="desconto" id="desconto" value="0" oninput="calcularTotal()" />
    </div>

    <div class="campo">
        <label for="total">Total com desconto:</label>
        <input type="text" id="total_exibicao" disabled />
    </div>

    <button type="submit">Finalizar Venda</button>
</form>

<script>
function adicionarItem() {
    const div = document.createElement('div');
    div.classList.add('item-venda');
    div.innerHTML = `
        <label>Produto:</label>
        <select name="produto_id">
            {% for produto in produtos %}
            <option value="{{ produto.id }}" data-preco="{{ produto.preco_venda }}">
                {{ produto.nome }} (R$ {{ '%.2f'|format(produto.preco_venda or 0) }})
            </option>
            {% endfor %}
        </select>
        <label>Quantidade:</label>
        <input type="number" name="quantidade" value="1" min="1">
    `;
    document.getElementById('itens-venda').appendChild(div);
    recalcularEventos();
}

function calcularTotal() {
    const quantidades = document.querySelectorAll('input[name="quantidade"]');
    const precos = document.querySelectorAll('select[name="produto_id"] option:checked');
    const desconto = parseFloat(document.getElementById('desconto').value) || 0;
    let total = 0;

    for (let i = 0; i < quantidades.length; i++) {
        const qtd = parseFloat(quantidades[i].value) || 0;
        const preco = parseFloat(precos[i].dataset.preco) || 0;
        total += qtd * preco;
    }

    total -= desconto;
    if (total < 0) total = 0;
    document.getElementById('total_exibicao').value = "R$ " + total.toFixed(2);
}

function recalcularEventos() {
    document.querySelectorAll('input[name="quantidade"], select[name="produto_id"]').forEach(elem => {
        elem.removeEventListener('input', calcularTotal);
        elem.addEventListener('input', calcularTotal);
    });
}

recalcularEventos();
</script>
{% endblock %}
