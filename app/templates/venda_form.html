{% extends "base.html" %}

{% block conteudo %}
<h1 class="titulo-pagina">Nova Venda</h1>

<form method="post" action="/vendas/nova" id="form-venda" class="formulario">
    <label>Cliente:</label>
    <select name="cliente_id" required>
        <option value="">Selecione um cliente</option>
        {% for cliente in clientes %}
            <option value="{{ cliente.id }}">{{ cliente.nome }}</option>
        {% endfor %}
    </select>

    <label>Forma de Pagamento:</label>
    <select name="forma_pagamento" required>
        <option value="avista">Ã€ Vista</option>
        <option value="prazo">A Prazo</option>
    </select>

    <div id="itens-venda">
        <h2>Produtos</h2>
        <div class="item-venda">
            <select name="produto_id" required>
                <option value="">Selecione o produto</option>
                {% for produto in produtos %}
                    <option value="{{ produto.id }}" data-preco="{{ produto.preco_venda }}">
                        {{ produto.nome }} - R$ {{ "%.2f"|format(produto.preco_venda or 0) }}
                    </option>
                {% endfor %}
            </select>
            <input type="number" step="0.01" name="quantidade" placeholder="Qtd (ex: 1.2)" required>
            <button type="button" onclick="removerItem(this)">Remover</button>
        </div>
    </div>

    <button type="button" onclick="adicionarItem()">Adicionar Produto</button>

    <label>Desconto (opcional):</label>
    <input type="number" step="0.01" name="desconto" id="desconto" value="0">

    <h3>Total: R$ <span id="total">0.00</span></h3>

    <button type="submit">Salvar Venda</button>
</form>

<script>
function adicionarItem() {
    const div = document.createElement("div");
    div.className = "item-venda";
    div.innerHTML = `
        <select name="produto_id" required>
            <option value="">Selecione o produto</option>
            {% for produto in produtos %}
                <option value="{{ produto.id }}" data-preco="{{ produto.preco_venda }}">
                    {{ produto.nome }} - R$ {{ "%.2f"|format(produto.preco_venda or 0) }}
                </option>
            {% endfor %}
        </select>
        <input type="number" step="0.01" name="quantidade" placeholder="Qtd (ex: 1.2)" required>
        <button type="button" onclick="removerItem(this)">Remover</button>
    `;
    document.getElementById("itens-venda").appendChild(div);
    atualizarTotal();
}

function removerItem(btn) {
    btn.parentElement.remove();
    atualizarTotal();
}

function atualizarTotal() {
    let total = 0;
    const itens = document.querySelectorAll("#itens-venda .item-venda");
    itens.forEach(item => {
        const select = item.querySelector("select");
        const input = item.querySelector("input[name='quantidade']");
        const preco = parseFloat(select.selectedOptions[0]?.getAttribute("data-preco")) || 0;
        const qtd = parseFloat(input.value) || 0;
        total += preco * qtd;
    });

    const desconto = parseFloat(document.getElementById("desconto").value) || 0;
    total -= desconto;

    document.getElementById("total").innerText = total.toFixed(2);
}

document.addEventListener("input", atualizarTotal);
</script>
{% endblock %}
